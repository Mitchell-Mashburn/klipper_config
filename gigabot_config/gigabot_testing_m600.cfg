[gcode_macro M600]
gcode:
  M117 Filament Change
  M118 Filament Change
  SAVE_GCODE_STATE NAME=filament_change
  G91 ; relative positioning
  G1 Z40 F3600 E-2 ; lift Z by 10mm
  M400
  UNLOAD_FILAMENT
  M400
  M117 Insert filament
  M118 Insert filament
  PAUSE
  G90
  UPDATE_DELAYED_GCODE ID=READY_LOAD DURATION=0.25

[delayed_gcode READY_LOAD]
gcode:
  {% if printer.pause_resume.is_paused %}
    M118 Checking paused. is_paused = true
    UPDATE_DELAYED_GCODE ID=READY_LOAD DURATION=0.25
  {% else %}
    PAUSE
    LOAD_FILAMENT
    M400
    M117 Press to resume print
    M118 Press to resume print
    UPDATE_DELAYED_GCODE ID= READY_RESUME DURATION=0.25
    UPDATE_DELAYED_GCODE ID= READY_LOAD DURATION=0
  {% endif %}

[delayed_gcode READY_RESUME]
gcode:
  {% if printer.pause_resume.is_paused %}
    UPDATE_DELAYED_GCODE ID= READY_RESUME DURATION=0.25
  {% else %}
    CLEAR_PAUSE
    RESTORE_GCODE_STATE NAME=filament_change MOVE=1
  {% endif %}
  


[gcode_macro LOAD_FILAMENT]
gcode:
        M117 Loading Filament...
        M118 Loading Filament...
        M83
        G1 E60 F1000
        G1 E100 F250
        G92 E0.0
        M400
        M117 Load Complete
        M118 Load Complete

[gcode_macro UNLOAD_FILAMENT]
gcode:
        M117 Unloading Filament...
        M118 Unloading Filament...
        G1 E0.5 F1000
        G1 E-0.5 F1000
        G1 E1.0 F1000
        G1 E-1.0 F1000
        G1 E1.5 F1000
        G1 E-1.5 F1000
        G1 E2.0 F1000
        G1 E-25 F1000
        M117 Remove Filament Now!
        M118 Remove Filament Now!
        M400

